---
title: ä½¿ç”¨ createContext åˆ›å»ºç»„ä»¶èƒ½å¤Ÿæä¾›ä¸è¯»å–çš„ ä¸Šä¸‹æ–‡ï¼ˆcontextï¼‰
description: ä½¿ç”¨ createContext åˆ›å»ºç»„ä»¶èƒ½å¤Ÿæä¾›ä¸è¯»å–çš„ ä¸Šä¸‹æ–‡ï¼ˆcontextï¼‰
category: å­¦ä¹ 
date: 2025-06-25
labels:
  - å­¦ä¹ 
  - Web
  - React
---

åœ¨ Next.js ä¸­ï¼Œä½ å¯ä»¥åˆ©ç”¨ React çš„ createContext API æ¥åˆ›å»ºå’Œç®¡ç†å…¨å±€çŠ¶æ€ï¼Œå¹¶åœ¨ç»„ä»¶æ ‘ä¸­å…±äº«æ•°æ®ï¼Œè€Œæ— éœ€æ‰‹åŠ¨é€šè¿‡ props ä¸€å±‚å±‚ä¼ é€’ã€‚è¿™å¯¹äºä¸»é¢˜ã€ç”¨æˆ·è®¤è¯ä¿¡æ¯æˆ–ä»»ä½•éœ€è¦åœ¨å¤šä¸ªç»„ä»¶ä¸­è®¿é—®çš„æ•°æ®éƒ½éå¸¸æœ‰ç”¨ã€‚

### 1.åˆ›å»ºä¸Šä¸‹æ–‡ (Context)

é¦–å…ˆï¼Œä½ éœ€è¦ä½¿ç”¨ createContext åˆ›å»ºä¸€ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡ã€‚é€šå¸¸ï¼Œæˆ‘ä»¬ä¼šå°†ä¸Šä¸‹æ–‡å®šä¹‰åœ¨ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶ä¸­ï¼Œä»¥ä¾¿äºç®¡ç†ã€‚

```tsx
// /components/features/context/index.tsx
"use client"; // ğŸ‘ˆ å¿…é¡»æ ‡è®°ä¸ºå®¢æˆ·ç«¯ç»„ä»¶ï¼Œå› ä¸ºè¿™é‡Œä½¿ç”¨äº† React Hooks å’Œæµè§ˆå™¨ API (localStorage)

import React, {
  createContext,
  useState,
  useContext,
  useCallback,
  useEffect, // å¼•å…¥ useEffect Hook ç”¨äºå‰¯ä½œç”¨æ“ä½œ (å¦‚ä¿å­˜æ•°æ®åˆ° localStorage)
  PropsWithChildren, // å¼•å…¥ PropsWithChildren ç”¨äºå®šä¹‰ children å±æ€§çš„ç±»å‹
} from "react";

// --- ç±»å‹å®šä¹‰ ---
// 1. å®šä¹‰é€šçŸ¥ (Notification) å¯¹è±¡çš„æ¥å£
interface Notification {
  id: number; // é€šçŸ¥IDï¼Œé€šå¸¸ä¸ºæ•°å­—
  message: string; // é€šçŸ¥å†…å®¹ï¼Œä¸ºå­—ç¬¦ä¸²
}

// 2. å®šä¹‰å…¨å±€çŠ¶æ€ Context ä¸­åŒ…å«çš„çŠ¶æ€å’Œå‡½æ•°çš„æ¥å£
interface GlobalStateContextType {
  theme: "light" | "dark"; // ä¸»é¢˜ï¼Œåªèƒ½æ˜¯ 'light' æˆ– 'dark'
  toggleTheme: () => void; // åˆ‡æ¢ä¸»é¢˜çš„å‡½æ•°ï¼Œæ— å‚æ•°æ— è¿”å›å€¼
  notifications: Notification[]; // é€šçŸ¥åˆ—è¡¨ï¼Œæ˜¯ä¸€ä¸ª Notification ç±»å‹çš„æ•°ç»„
  addNotification: (message: string) => void; // æ·»åŠ é€šçŸ¥çš„å‡½æ•°ï¼Œæ¥å—ä¸€ä¸ªå­—ç¬¦ä¸²æ¶ˆæ¯
  removeNotification: (id: number) => void; // ç§»é™¤é€šçŸ¥çš„å‡½æ•°ï¼Œæ¥å—ä¸€ä¸ªæ•°å­—ID
}

// --- Context åˆ›å»º ---
// 3. åˆ›å»ºå…¨å±€çŠ¶æ€ Context å¯¹è±¡
// è¿™é‡Œæ˜ç¡®æŒ‡å®š Context çš„ç±»å‹ä¸º GlobalStateContextType æˆ– undefinedã€‚
// é»˜è®¤å€¼è®¾ç½®ä¸º undefinedï¼Œä»¥ä¾¿åœ¨ä½¿ç”¨ useContext æ—¶å¯ä»¥æ£€æŸ¥æ˜¯å¦åœ¨ Provider å†…éƒ¨ã€‚
export const GlobalStateContext = createContext<
  GlobalStateContextType | undefined
>(undefined);

// --- Provider ç»„ä»¶ ---
// 4. åˆ›å»ºå…¨å±€çŠ¶æ€ Provider ç»„ä»¶
// ä½¿ç”¨ PropsWithChildren æ¥ç®€åŒ– children å±æ€§çš„ç±»å‹å®šä¹‰
export const GlobalStateProvider = ({ children }: PropsWithChildren) => {
  // åˆå§‹åŒ–ä¸»é¢˜çŠ¶æ€ï¼šå°è¯•ä» localStorage è¯»å–ï¼Œå¦‚æœä¸å­˜åœ¨æˆ–åœ¨æœåŠ¡å™¨ç«¯ï¼Œåˆ™é»˜è®¤ä¸º 'light'
  const [theme, setTheme] = useState<"light" | "dark">(() => {
    // æ£€æŸ¥å½“å‰ç¯å¢ƒæ˜¯å¦æ˜¯æµè§ˆå™¨ï¼ˆå®¢æˆ·ç«¯ï¼‰
    if (typeof window !== "undefined") {
      const storedTheme = localStorage.getItem("appTheme"); // ä» localStorage è·å–ä¿å­˜çš„ä¸»é¢˜
      // ä¸¥æ ¼æ£€æŸ¥è·å–åˆ°çš„å€¼ï¼Œç¡®ä¿å®ƒæ˜¯ 'dark' æˆ– 'light'ï¼Œå¦åˆ™ä½¿ç”¨ 'light'
      return storedTheme === "dark" ? "dark" : "light";
    }
    return "light"; // å¦‚æœæ˜¯æœåŠ¡å™¨ç«¯æ¸²æŸ“æˆ–åˆæ¬¡åŠ è½½æ—¶ï¼Œé»˜è®¤ä½¿ç”¨ 'light'
  });

  // åˆå§‹åŒ–é€šçŸ¥åˆ—è¡¨çŠ¶æ€ï¼šå°è¯•ä» localStorage è¯»å–ï¼Œå¦‚æœä¸å­˜åœ¨æˆ–è§£æå¤±è´¥ï¼Œåˆ™é»˜è®¤ä¸ºç©ºæ•°ç»„
  const [notifications, setNotifications] = useState<Notification[]>(() => {
    if (typeof window !== "undefined") {
      const storedNotifications = localStorage.getItem("appNotifications"); // ä» localStorage è·å–ä¿å­˜çš„é€šçŸ¥
      try {
        // å°è¯•å°† JSON å­—ç¬¦ä¸²è§£æå›æ•°ç»„ï¼Œå¦‚æœå¤±è´¥åˆ™è¿”å›ç©ºæ•°ç»„
        return storedNotifications ? JSON.parse(storedNotifications) : [];
      } catch (e) {
        console.error("è§£æä¿å­˜çš„é€šçŸ¥å¤±è´¥:", e); // æ‰“å°è§£æé”™è¯¯
        return []; // è§£æå¤±è´¥æ—¶è¿”å›ç©ºæ•°ç»„
      }
    }
    return []; // å¦‚æœæ˜¯æœåŠ¡å™¨ç«¯æ¸²æŸ“ï¼Œé»˜è®¤è¿”å›ç©ºæ•°ç»„
  });

  // ä½¿ç”¨ useEffect ç›‘å¬ 'theme' çŠ¶æ€å˜åŒ–ï¼Œå¹¶å°†å…¶ä¿å­˜åˆ° localStorage
  useEffect(() => {
    if (typeof window !== "undefined") {
      localStorage.setItem("appTheme", theme); // å°†å½“å‰ä¸»é¢˜ä¿å­˜åˆ° localStorage
    }
  }, [theme]); // ä¾èµ–æ•°ç»„ï¼šå½“ 'theme' å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæ­¤ effect ä¼šé‡æ–°è¿è¡Œ

  // ä½¿ç”¨ useEffect ç›‘å¬ 'notifications' çŠ¶æ€å˜åŒ–ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸º JSON å­—ç¬¦ä¸²ä¿å­˜åˆ° localStorage
  useEffect(() => {
    if (typeof window !== "undefined") {
      localStorage.setItem("appNotifications", JSON.stringify(notifications)); // å°†é€šçŸ¥æ•°ç»„è½¬æ¢ä¸º JSON å­—ç¬¦ä¸²å¹¶ä¿å­˜
    }
  }, [notifications]); // ä¾èµ–æ•°ç»„ï¼šå½“ 'notifications' å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæ­¤ effect ä¼šé‡æ–°è¿è¡Œ

  // --- Actions (æ“ä½œå‡½æ•°) ---
  // ä½¿ç”¨ useCallback ä¼˜åŒ– toggleTheme å‡½æ•°ï¼Œé¿å…ä¸å¿…è¦çš„é‡æ–°åˆ›å»º
  const toggleTheme = useCallback(() => {
    setTheme((prevTheme) => (prevTheme === "light" ? "dark" : "light"));
  }, []); // ä¾èµ–æ•°ç»„ä¸ºç©ºï¼Œè¡¨ç¤ºæ­¤å‡½æ•°ä¸ä¼šå› å¤–éƒ¨å˜é‡å˜åŒ–è€Œæ”¹å˜

  // ä½¿ç”¨ useCallback ä¼˜åŒ– addNotification å‡½æ•°
  const addNotification = useCallback((message: string) => {
    setNotifications((prevNotifications) => [
      ...prevNotifications, // å±•å¼€ä¹‹å‰çš„é€šçŸ¥
      { id: Date.now(), message }, // æ·»åŠ æ–°çš„é€šçŸ¥ï¼Œid ä½¿ç”¨å½“å‰æ—¶é—´æˆ³
    ]);
  }, []);

  // ä½¿ç”¨ useCallback ä¼˜åŒ– removeNotification å‡½æ•°
  const removeNotification = useCallback((id: number) => {
    setNotifications(
      (prevNotifications) =>
        prevNotifications.filter((notif) => notif.id !== id) // è¿‡æ»¤æ‰æŒ‡å®š id çš„é€šçŸ¥
    );
  }, []);

  // å°†æ‰€æœ‰çŠ¶æ€å’Œæ“ä½œå‡½æ•°æ‰“åŒ…æˆä¸€ä¸ªå¯¹è±¡ï¼Œä½œä¸º Context çš„ value
  const contextValue: GlobalStateContextType = {
    theme,
    toggleTheme,
    notifications,
    addNotification,
    removeNotification,
  };

  return (
    // æä¾› Context çš„å€¼ç»™æ‰€æœ‰å­ç»„ä»¶
    <GlobalStateContext.Provider value={contextValue}>
      {children}
    </GlobalStateContext.Provider>
  );
};

// --- Hook for Context Consumption ---
// 5. åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰ Hookï¼Œæ–¹ä¾¿åœ¨ç»„ä»¶ä¸­ä½¿ç”¨å…¨å±€çŠ¶æ€ï¼ˆä½¿ç”¨æ­¤ Hook çš„åœ°æ–¹ï¼Œå¿…é¡»å£°æ˜åœ¨å®¢æˆ·ç«¯ -> "use client"ï¼‰
export const useGlobalState = () => {
  const context = useContext(GlobalStateContext); // è·å– Context çš„å€¼
  // å¦‚æœ context ä¸º undefinedï¼Œè¯´æ˜ useGlobalState åœ¨ Provider å¤–éƒ¨è¢«è°ƒç”¨ï¼ŒæŠ›å‡ºé”™è¯¯
  if (context === undefined) {
    throw new Error("useGlobalState å¿…é¡»åœ¨ GlobalStateProvider å†…éƒ¨ä½¿ç”¨");
  }
  return context; // è¿”å› Context çš„å€¼
};
```

### 2.æä¾›ä¸Šä¸‹æ–‡ (Context Provider)

åˆ›å»ºä¸Šä¸‹æ–‡åï¼Œä½ éœ€è¦ä½¿ç”¨ä¸Šä¸‹æ–‡å¯¹è±¡çš„ .Provider ç»„ä»¶æ¥â€œæä¾›â€æ•°æ®ã€‚Provider ç»„ä»¶æ¥æ”¶ä¸€ä¸ª value propï¼Œè¿™ä¸ª value å°†æ˜¯æ‰€æœ‰æ¶ˆè´¹è¿™ä¸ªä¸Šä¸‹æ–‡çš„å­ç»„ä»¶èƒ½å¤Ÿè®¿é—®åˆ°çš„æ•°æ®ã€‚é€šå¸¸ï¼Œä½ ä¼šåœ¨åº”ç”¨çš„é«˜å±‚çº§ï¼ˆä¾‹å¦‚ _app.js æˆ–ä¸€ä¸ªå¸ƒå±€ç»„ä»¶ï¼‰åŒ…è£… Providerã€‚

åœ¨ _app.js ä¸­æä¾›ä¸Šä¸‹æ–‡ (é€‚ç”¨äºå…¨å±€æ•°æ®)
å¦‚æœä½ å¸Œæœ›ä¸Šä¸‹æ–‡æ•°æ®åœ¨æ•´ä¸ª Next.js åº”ç”¨ä¸­éƒ½å¯ç”¨ï¼Œé‚£ä¹ˆåœ¨ pages/layout.tsx ä¸­åŒ…è£¹ Provider æ˜¯ä¸€ä¸ªå¸¸è§çš„åšæ³•ã€‚

```tsx
// pages/layout.tsx
import "../styles/tailwindcss.css";
import Header from "@/components/layout/header";
import { GlobalStateProvider } from "@/components/features/context";

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en">
      <body suppressHydrationWarning className="max-w-3xl m-auto p-5">
        <GlobalStateProvider>
          <Header />
          {children}
        </GlobalStateProvider>
      </body>
    </html>
  );
}
```

### 3.ä½¿ç”¨ Hook è¯»å–ä¸Šä¸‹æ–‡ (Consuming Context)

è¿™æ˜¯åœ¨å‡½æ•°ç»„ä»¶ä¸­è¯»å–ä¸Šä¸‹æ–‡æœ€æ¨èçš„æ–¹å¼,å®ƒç®€æ´ä¸”æ˜“äºä½¿ç”¨ã€‚

```tsx
'use client';

import { useGlobalState } from '@/components/features/context';

export default function Home() {
  const { theme, toggleTheme } = useGlobalState();
  console.log(theme);
  return (
    <main>
      <button onClick={() => toggleTheme()}>ä¸»é¢˜åˆ‡æ¢</button>
    </main>
  );
}
```